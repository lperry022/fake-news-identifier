<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Profile · Fake News Identifier</title>

  <!-- Materialize CSS + Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Optional: your site styles -->
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body class="theme-dark">

  <!-- Top bar -->
  <nav class="nav-glass">
    <div class="nav-wrapper container">
      <a href="/" class="brand-logo truncate">Fake News Identifier</a>
      <ul class="right">
        <li><a id="logoutBtn" href="#!"><i class="material-icons left">logout</i>Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="container" style="margin-top:2rem">
    <h4 class="white-text">My Profile</h4>

    <!-- Account info -->
    <div class="card-panel grey darken-4 white-text z-depth-2">
      <div class="card-content white-text">
        <span class="card-title">Account</span>

        <div class="row" style="margin-bottom: 0.75rem">
          <div class="col s12 m6">
            <p><strong>Name:</strong> <span id="nameText">—</span></p>
          </div>
          <div class="col s12 m6">
            <p><strong>Email:</strong> <span id="emailText">—</span></p>
          </div>
        </div>
        <div class="row" style="margin-bottom: 0.75rem">
          <div class="col s12">
            <p><strong>User ID:</strong> <span id="idText">—</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Change display name -->
    <div class="card z-depth-1 dark-card">
      <div class="card-content white-text">
        <span class="card-title">Change display name</span>
        <div class="row" style="margin-top: 0.5rem">
          <div class="input-field col s12 m8">
            <input id="newName" type="text" />
            <label for="newName">New name</label>
          </div>
          <div class="input-field col s12 m4">
            <button id="saveNameBtn" class="btn deep-purple waves-effect waves-light" style="width:100%">
              <i class="material-icons left">save</i>Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Not logged in notice -->
    <div id="notAuth" class="card red darken-2" style="display:none">
      <div class="card-content white-text">
        <span class="card-title"><i class="material-icons left">error_outline</i>Not logged in</span>
        <p>Go back to the <a href="/" class="yellow-text text-lighten-3">home page</a> and use the Log in button.</p>
      </div>
    </div>
  </main>

  <footer class="page-footer footer-compact">
    <div class="container">© 2025 Group 11 · Fake News Identifier</div>
  </footer>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js" defer></script>

  <!-- Inline page logic -->
  <script>
    // tiny helpers
    const $  = (sel) => document.querySelector(sel);
    const toast = (msg) => window.M && M.toast({ html: msg });

    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      const data = await r.json().catch(() => ({}));
      return { ok: r.ok, status: r.status, data };
    }
    async function putJSON(url, body) {
      const r = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(() => ({}));
      return { ok: r.ok, status: r.status, data };
    }

    async function loadProfile() {
      // try /api/profile first; fall back to /auth/me if not present
      let res = await fetchJSON("/api/profile", { credentials: "include" });
      if (!res.ok) res = await fetchJSON("/auth/me", { credentials: "include" });

      if (!res.ok) {
        $("#notAuth").style.display = "";
        return;
      }

      const user = res.data.user || res.data; // /auth/me may return { ok, user }
      $("#nameText").textContent  = user.name || "—";
      $("#emailText").textContent = user.email || "—";
      $("#idText").textContent    = user.id || user._id || "—";

      // prefill input & keep Materialize label floated
      $("#newName").value = user.name || "";
      if (window.M && M.updateTextFields) M.updateTextFields();
    }

    async function saveName() {
      const name = ($("#newName").value || "").trim();
      if (!name) return toast("Enter a name");
      const res = await putJSON("/api/profile", { name });
      if (!res.ok) return toast(res.data?.error || "Failed to update name");
      const user = res.data.user || {};
      $("#nameText").textContent = user.name || name;
      toast("Name updated");
    }

    async function doLogout() {
      try {
        await fetch("/auth/logout", { method: "POST", credentials: "include" });
      } catch {}
      location.href = "/";
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.M) M.AutoInit();
      loadProfile();

      $("#saveNameBtn")?.addEventListener("click", saveName);
      $("#logoutBtn")?.addEventListener("click", doLogout);
    });
  </script>
</body>
</html>